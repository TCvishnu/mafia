<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAFIA: The Gathering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Hide scrollbar but keep scrolling */
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        -ms-overflow-style: none; /* IE/Edge */
        scrollbar-width: none; /* Firefox */
      }
    </style>
  </head>

  <body
    class="bg-[#050505] text-white font-mono flex justify-center items-start min-h-screen py-10 relative overflow-x-hidden"
  >
    <!-- Scanline Overlay -->
    <div
      class="pointer-events-none absolute inset-0 z-10 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%]"
    ></div>

    <!-- Main Frame -->
    <div
      class="relative bg-[#050505] border-4 border-white p-6 w-[95%] max-w-5xl shadow-[0_0_20px_rgba(255,255,255,0.1)] uppercase"
    >
      <!-- Header -->
      <div
        class="text-[1.8rem] sm:text-[2rem] md:text-[2.5rem] font-black text-center border-b-[8px] border-white mb-[30px] pb-[10px] tracking-[-2px] font-['Impact']"
      >
        The Gathering
      </div>

      <!-- Responsive Layout -->
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- LEFT: Players -->
        <div class="flex-1 max-h-[60vh] overflow-y-auto pr-2 hide-scrollbar">
          <div id="playersContainer" class="space-y-4"></div>
        </div>

        <!-- RIGHT: Controls -->
        <div class="lg:w-[220px] flex flex-col gap-4 justify-between">
          <button
            onclick="addPlayer()"
            class="w-full py-3 bg-white text-[#050505] font-bold tracking-wide"
          >
            + ADD PLAYER
          </button>

          <button
            onclick="saveAndProceed()"
            class="w-full py-3 bg-red-500 text-white font-bold tracking-wide"
          >
            PROCEED
          </button>
        </div>
      </div>

      <!-- Stamp -->
      <div
        class="absolute bottom-[-40px] right-[-20px] border-[3px] border-red-600 text-red-600 px-[10px] py-[5px] font-bold rotate-[-15deg] opacity-60 pointer-events-none"
      >
        CONFIDENTIAL
      </div>
    </div>

    <!-- Themed Popup -->
    <div
      id="themedPopup"
      class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-[#050505] border-4 border-white p-6 w-[90%] max-w-sm uppercase shadow-[0_0_20px_rgba(255,255,255,0.1)] relative"
      >
        <div
          class="pointer-events-none absolute inset-0 z-10 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%]"
        ></div>
        <div
          class="text-xl font-black text-center border-b-4 border-white mb-4 pb-2 font-['Impact']"
        >
          NOTICE
        </div>

        <div id="popupMessage" class="text-center mb-6 text-sm tracking-wide">
          Minimum 3 players required.
        </div>

        <button
          onclick="closePopup()"
          class="w-full py-2 bg-red-500 text-white font-bold tracking-wide"
        >
          ROGER
        </button>
      </div>
    </div>

    <script>
      const container = document.getElementById("playersContainer");

      window.onload = function () {
        let players = JSON.parse(localStorage.getItem("playersList") || "[]");

        const minRequired = getMinimumRequiredPlayers();

        // If no players stored at all → initialize fresh
        if (players.length === 0) {
          for (let i = 1; i <= minRequired; i++) {
            players.push(String(i));
          }
        }

        // If below minimum → only add missing ones
        if (players.length < minRequired) {
          const currentLength = players.length;

          for (let i = currentLength + 1; i <= minRequired; i++) {
            players.push(String(i));
          }
        }

        // Render players
        players.forEach((name) => createPlayerInput(name));

        savePlayers();
      };

      function getMinimumRequiredPlayers() {
        const mafiaCount = parseInt(localStorage.getItem("mafias") || "1");
        const hasDoctor = localStorage.getItem("doctor") === "YES";
        const hasDetective = localStorage.getItem("detective") === "YES";

        const specialRoles = (hasDoctor ? 1 : 0) + (hasDetective ? 1 : 0);

        return 2 * mafiaCount + specialRoles;
      }

      function createPlayerInput(name = "") {
        const wrapper = document.createElement("div");
        wrapper.className =
          "flex justify-between items-center border-b border-[#444] pb-2";

        wrapper.innerHTML = `
      <input 
        type="text"
        value="${name}"
        class="bg-transparent text-white font-mono text-sm w-[75%] outline-none focus:text-red-500"
        oninput="savePlayers()"
      />
      <button 
        onclick="removePlayer(this)"
        class="w-8 h-8 flex items-center justify-center 
               border border-red-500 text-red-500 
               hover:bg-red-500 hover:text-white 
               transition duration-200 text-sm font-bold">
        ✕
      </button>
    `;

        container.appendChild(wrapper);
      }

      function addPlayer() {
        const count = container.querySelectorAll("input").length;

        createPlayerInput(String(count + 1));

        normalizeNumbersIfNeeded();
        savePlayers();

        container.scrollTo({
          top: container.scrollHeight,
          behavior: "smooth",
        });
      }

      function removePlayer(button) {
        const total = container.querySelectorAll("input").length;
        const minRequired = getMinimumRequiredPlayers();

        if (total - 1 < minRequired) {
          showPopup(`Minimum ${minRequired} players required.`);
          return;
        }

        button.parentElement.remove();

        normalizeNumbersIfNeeded();
        savePlayers();
      }

      function normalizeNumbersIfNeeded() {
        const inputs = Array.from(container.querySelectorAll("input"));
        const values = inputs.map((i) => i.value.trim());

        const allNumeric = values.every((val) => /^[0-9]+$/.test(val));

        if (!allNumeric) return;

        inputs.forEach((input, index) => {
          input.value = String(index + 1);
        });
      }

      function savePlayers() {
        const players = Array.from(container.querySelectorAll("input")).map(
          (input) => input.value.trim(),
        );

        localStorage.setItem("playersList", JSON.stringify(players));
      }

      function saveAndProceed() {
        savePlayers();
        window.location.href = "roles.html";
      }

      function showPopup(message) {
        const popup = document.getElementById("themedPopup");
        const messageBox = document.getElementById("popupMessage");

        messageBox.textContent = message;
        popup.classList.remove("hidden");
      }

      function closePopup() {
        const popup = document.getElementById("themedPopup");
        popup.classList.add("hidden");
      }
    </script>
  </body>
</html>
