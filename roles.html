<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAFIA: Identity Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="bg-[#050505] text-white font-mono flex justify-center items-center min-h-screen relative overflow-hidden"
  >
    <!-- Scanlines -->
    <div
      class="pointer-events-none absolute inset-0 z-10 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%]"
    ></div>

    <div
      class="relative border-4 border-white p-10 w-[90%] max-w-xl text-center uppercase"
    >
      <div
        class="text-3xl font-black border-b-8 border-white pb-4 mb-10 tracking-[-1px] font-['Impact']"
      >
        Identity Protocol
      </div>
      <!-- HANDOUT SCREEN -->
      <div id="handoutScreen" class="flex justify-center">
        <div
          class="relative bg-white text-black w-full max-w-md p-6 shadow-2xl border-4 border-black uppercase"
        >
          <!-- Government Header -->
          <div class="text-center border-b-2 border-black pb-3 mb-4 mt-2">
            <div class="text-xs tracking-widest">Government of Nightfall</div>
            <div class="text-lg font-black tracking-wider">
              Village Citizen Registry
            </div>
            <div class="text-[10px] tracking-widest mt-1">
              Official Identification Record
            </div>
          </div>

          <!-- File Info -->
          <div class="text-xs mb-4 flex justify-between">
            <span id="fileNumber"></span>
            <span id="zone"></span>
          </div>

          <!-- Citizen Info Box -->
          <div class="border-2 border-black p-4 mb-6 bg-gray-100">
            <div class="text-xs mb-2">CITIZEN NAME</div>
            <div
              id="handoutName"
              class="text-xl font-bold tracking-widest border-b border-black pb-1"
            ></div>

            <div class="mt-4 text-xs">STATUS: PENDING VERIFICATION</div>
          </div>

          <div
            class="absolute top-1 right-1 text-[10px] border border-black px-2 py-1"
          >
            TEMP FILE
          </div>

          <!-- Issue Button -->
          <button
            onclick="startVerification()"
            class="w-full py-3 bg-black text-white font-bold tracking-widest hover:bg-red-700 transition"
          >
            ISSUE DOCUMENT
          </button>
        </div>
      </div>

      <div id="terminalScreen" class="hidden">
        <div
          id="terminalArea"
          class="text-left text-md leading-relaxed whitespace-pre-wrap"
        ></div>
      </div>
      <div
        class="absolute bottom-[-40px] right-[-10px] border-[3px] border-red-600 text-red-600 px-[10px] py-[5px] font-bold rotate-[-15deg] opacity-60 pointer-events-none"
      >
        CONFIDENTIAL
      </div>
      <div id="roleBadge" class="hidden"></div>
    </div>

    <script>
      const players = JSON.parse(localStorage.getItem("playersList") || "[]");
      const mafiaCount = parseInt(localStorage.getItem("mafias") || "1");
      const hasDoctor = localStorage.getItem("doctor") === "YES";
      const hasDetective = localStorage.getItem("detective") === "YES";

      const handoutScreen = document.getElementById("handoutScreen");
      const terminalScreen = document.getElementById("terminalScreen");
      const handoutName = document.getElementById("handoutName");

      let roles = [];
      let currentIndex = 0;
      const terminal = document.getElementById("terminalArea");

      init();

      function init() {
        generateRoles();
        showHandout();
      }

      function showHandout() {
        if (currentIndex >= players.length) {
          endSequence();
          return;
        }

        const name = players[currentIndex];
        const displayName = /^[0-9]+$/.test(name)
          ? `PLAYER ${name}`
          : name.toUpperCase();

        handoutName.textContent = displayName;

        terminalScreen.classList.add("hidden");
        handoutScreen.classList.remove("hidden");
        callGenerateFileNumber();
      }
      function startVerification() {
        handoutScreen.classList.add("hidden");
        terminalScreen.classList.remove("hidden");
        runSequence();
      }

      function generateRoles() {
        roles = [];

        for (let i = 0; i < mafiaCount; i++) roles.push("MAFIA");
        if (hasDoctor) roles.push("DOCTOR");
        if (hasDetective) roles.push("DETECTIVE");

        while (roles.length < players.length) {
          roles.push("VILLAGER");
        }

        shuffle(roles);
        shuffle(roles);
      }

      function shuffle(array) {
        const cryptoArray = new Uint32Array(1);

        for (let i = array.length - 1; i > 0; i--) {
          crypto.getRandomValues(cryptoArray);
          const j = cryptoArray[0] % (i + 1);

          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      async function runSequence() {
        if (currentIndex >= players.length) {
          endSequence();
          return;
        }

        terminal.innerHTML = "";

        const name = players[currentIndex];
        const displayName = /^[0-9]+$/.test(name)
          ? `PLAYER ${name}`
          : name.toUpperCase();

        await typeLine(`> VILLAGE CITIZEN RECORD`);
        await delay(800);

        await typeLine(`> ANALYZING CITIZEN NAME...`);
        await delay(700);

        await typeLine(`> NAME: ${displayName}`);
        await delay(900);

        await typeLine(`> VERIFYING CITIZEN STATUS:`);
        await delay(400);
        if (roles[currentIndex] === "MAFIA") {
          await delay(600);
          await typeLine(`> ERROR: RECORD MISMATCH`);
          await delay(700);

          await typeLine(`> CROSS-CHECKING...`);
          await delay(900);
        }
        const roleHTML = getRoleDisplay(roles[currentIndex]);
        terminal.innerHTML += `<div class="py-3 text-4xl tracking-wider">   ${roleHTML}</div>`;

        showRoleBadge(roles[currentIndex]);

        await delay(500);
        await typeLine(`> NEXT APPLICANT PLEASE`);

        terminal.onclick = () => {
          terminal.onclick = null;
          currentIndex++;
          hideRoleBadge();
          showHandout();
        };
      }

      async function typeLine(text) {
        for (let i = 0; i < text.length; i++) {
          terminal.innerHTML += text[i];
          await delay(20);
        }
        terminal.innerHTML += "\n";
      }

      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function endSequence() {
        terminal.onclick = null;

        terminal.innerHTML = `
        > ALL ROLES ASSIGNED

        > LET THE MAYHEM BEGIN

        > TAP TO RETURN
        `;

        terminal.onclick = () => {
          window.location.href = "index.html";
        };
      }

      function getRoleDisplay(role) {
        switch (role) {
          case "MAFIA":
            return `<span class="text-red-500">MAFIA</span>`;
          case "DOCTOR":
            return `<span class="text-green-500">DOCTOR</span>`;
          case "DETECTIVE":
            return `<span class="text-green-500">DETECTIVE</span>`;
          default:
            return `<span class="text-white">VILLAGER</span>`;
        }
      }

      async function loadingDots(count = 5, speed = 200) {
        // Add dots one by one
        for (let i = 1; i <= count; i++) {
          terminal.innerHTML += ".";
          await delay(speed);
        }

        // Remove dots one by one
        for (let i = count; i > 0; i--) {
          await delay(speed);
          terminal.innerHTML = terminal.innerHTML.slice(0, -1);
        }
      }
      function hideRoleBadge(role) {
        const badge = document.getElementById("roleBadge");
        badge.classList.add("hidden");
      }

      function showRoleBadge(role) {
        const badge = document.getElementById("roleBadge");

        badge.className = `
        absolute
        top-[-45px]
        left-[-25px]
        w-40 h-40
        rounded-full
        flex items-center justify-center
        font-black
        uppercase
        tracking-[3px]
        rotate-[-18deg]
        opacity-90
        pointer-events-none
        z-20
      `;

        // Base ring
        let colorClasses =
          role === "MAFIA"
            ? "border-red-800 text-red-800"
            : "border-green-700 text-green-700";

        badge.classList.add(
          "border-4",
          colorClasses.split(" ")[0],
          colorClasses.split(" ")[1],
        );

        const innerRingColor =
          role === "MAFIA" ? "border-red-800" : "border-green-700";

        badge.innerHTML = `
        <div class="absolute w-32 h-32 rounded-full border-2 ${innerRingColor}"></div>
        <div class="text-center leading-tight text-xs">
          ${role === "MAFIA" ? "RECORD<br/>REJECTED" : "APPROVED"}
        </div>`;

        // Ink texture effect
        badge.style.filter = "contrast(120%) brightness(90%)";
        badge.style.boxShadow = "0 0 15px rgba(0,0,0,0.6)";
        badge.style.opacity = 0.85;

        badge.classList.remove("hidden");
      }
      function generateFileNumber() {
        const districtCode = Math.floor(10 + Math.random() * 90);
        const fileCode = Math.floor(1000 + Math.random() * 9000);
        const randomPart = Math.floor(10000 + Math.random() * 90000);
        return `FILE NO: NF/${districtCode}-${fileCode}/${randomPart}`;
      }

      function callGenerateFileNumber() {
        document.getElementById("fileNumber").textContent =
          generateFileNumber();

        document.getElementById("zone").textContent = generateZone();
      }

      function generateZone() {
        const zones = [
          "EAST HAMLET",
          "WEST HAMLET",
          "NORTH FIELDS",
          "SOUTH FARMLANDS",
          "RIVER BANK",
          "MANGO GROVE",
          "TEMPLE ROAD",
          "PANCHAYAT LANE",
          "OLD WELL AREA",
          "BANYAN TREE SQUARE",
          "HARVEST FIELDS",
          "CATTLE SHED ROW",
          "PALM GROVE",
          "LAKE SIDE",
          "CHURCH HILL",
          "MARKET CHOWK",
          "SCHOOL ROAD",
          "MUD HOUSE CLUSTER",
          "FOREST BORDER",
          "CANAL SIDE",
          "THOTTAM AREA",
          "KULAM SIDE",
          "PADAM FIELDS",
          "CHAVADI LANE",
          "AGRAHARAM STREET",
          "KOIL STREET",
        ];

        const randomZone = zones[Math.floor(Math.random() * zones.length)];

        return `ZONE: ${randomZone}`;
      }
    </script>
  </body>
</html>
